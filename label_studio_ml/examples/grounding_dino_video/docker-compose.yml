version: "3.11"

services:
  grounding_dino_video:
    container_name: grounding_dino_video
    image: humansignal/grounding-dino-video:dev
    build:
      context: .
      args:
        TEST_ENV: ${TEST_ENV}
    environment:
      # specify these parameters if you want to use basic auth for the model server
      BASIC_AUTH_USER: ""
      BASIC_AUTH_PASS: ""
      # set the log level for the model server
      LOG_LEVEL: INFO
      WORKERS: "1"
      THREADS: "8"
      PYTHONPATH: /app

      # Label Studio connectivity
      LABEL_STUDIO_HOST: https://app.heartex.com
      LABEL_STUDIO_URL: https://app.heartex.com
      LABEL_STUDIO_API_KEY: ${LABEL_STUDIO_API_KEY}

      # Grounding DINO configuration
      # Use very low detection thresholds - let tracker filter instead
      GROUNDING_DINO_PROMPT: person
      GROUNDING_DINO_BOX_THRESHOLD: "0.05"
      GROUNDING_DINO_TEXT_THRESHOLD: "0.10"
      GROUNDING_DINO_DEVICE: cuda
      GROUNDING_DINO_CONFIG: GroundingDINO_SwinT_OGC.py
      GROUNDING_DINO_WEIGHTS: gdino_swint_darpa-ir-v1-1k_20_1.pth
      MODEL_SCORE_THRESHOLD: "0.3"

      # Batch size for GPU inference (default: 8)
      # Try batch_size=1 to test if batching is causing detection issues
      GROUNDING_DINO_BATCH_SIZE: "1"
      
      # Frame skipping: "1" = no skipping, "2" = 2x speedup, "auto" = auto-determine
      GROUNDING_DINO_FRAME_SKIP: "1"

      SPARSIFY_KF_FOR_SAM: "false"

      # ==========================================================================
      # TRACKING CONFIGURATION (ByteTrack parameters)
      # ==========================================================================
      # For long UAV videos with few subjects, use aggressive anti-fragmentation:
      track_activation_threshold: "0.3"     # Confidence to start new track
      lost_track_buffer: "900"              # 30 seconds at 30fps - keep tracks alive longer
      minimum_matching_threshold: "0.1"     # Very permissive IoU matching
      minimum_consecutive_frames: "3"       # Frames needed to confirm track

    extra_hosts:
      - "host.docker.internal:host-gateway"  # for macos and unix      
    ports:
      - "9090:9090"
    volumes:
      - "./data/server:/data"
      - "./cache_dir:/app/cache_dir"
      - "./output_frames:/app/output_frames"
      # Mount source code for live updates (no rebuild needed)
      - "./utils:/app/utils"
      - "./control_models:/app/control_models"
      - "./model.py:/app/model.py"
      - "./cli.py:/app/cli.py"
      - "./tracking_presets.py:/app/tracking_presets.py"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
