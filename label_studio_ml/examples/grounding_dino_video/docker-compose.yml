version: "3.11"

services:
  grounding_dino_video:
    container_name: grounding_dino_video
    image: humansignal/grounding-dino-video:dev
    build:
      context: .
      args:
        TEST_ENV: ${TEST_ENV}
    environment:
      # specify these parameters if you want to use basic auth for the model server
      BASIC_AUTH_USER: ""
      BASIC_AUTH_PASS: ""
      # set the log level for the model server
      LOG_LEVEL: INFO
      WORKERS: "1"
      THREADS: "8"
      PYTHONPATH: /app

      # Label Studio connectivity
      LABEL_STUDIO_HOST: https://app.heartex.com
      LABEL_STUDIO_URL: https://app.heartex.com
      LABEL_STUDIO_API_KEY: ${LABEL_STUDIO_API_KEY}

      # Grounding DINO configuration
      GROUNDING_DINO_PROMPT: person
      GROUNDING_DINO_BOX_THRESHOLD: "0.20"
      GROUNDING_DINO_TEXT_THRESHOLD: "0.25"
      GROUNDING_DINO_DEVICE: cuda
      GROUNDING_DINO_CONFIG: GroundingDINO_SwinT_OGC.py
      GROUNDING_DINO_WEIGHTS: gdino_swint_darpa-ir-v1-1k_20_1.pth
      MODEL_SCORE_THRESHOLD: "0.5"

      SPARSIFY_KF_FOR_SAM: "false"

      # track_activation_threshold (float): Detection confidence threshold for track activation.
      #   Increasing track_activation_threshold improves accuracy and stability but might miss
      #   true detections. Decreasing it increases completeness but risks introducing noise and
      #   instability.
      # lost_track_buffer (int): Number of frames to buffer when a track is lost. Increasing
      #   lost_track_buffer enhances occlusion handling, significantly reducing the likelihood of
      #   track fragmentation or disappearance caused by brief detection gaps.
      # minimum_matching_threshold (float): Threshold for matching tracks with detections.
      #   Increasing minimum_matching_threshold improves accuracy but risks fragmentation.
      #   Decreasing it improves completeness but risks false positives and drift.
      # minimum_consecutive_frames (int): Frames an object must be tracked before it's considered
      #   valid. Increasing minimum_consecutive_frames prevents accidental tracks from false or
      #   duplicate detections but may miss shorter tracks.
      # Tracker configuration defaults mirror ByteTrack
      TRACKER_ACTIVATION_THRESHOLD: "0.2"
      TRACKER_LOST_BUFFER: "100"
      TRACKER_MATCH_THRESHOLD: "0.5"
      TRACKER_MIN_CONSECUTIVE_FRAMES: "5"

    extra_hosts:
      - "host.docker.internal:host-gateway"  # for macos and unix      
    ports:
      - "9090:9090"
    volumes:
      - "./data/server:/data"
      - "./cache_dir:/app/cache_dir"
      - "./output_frames:/app/output_frames"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
